<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>雷神録</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
 <link rel="icon" href="https://deliver.commons.nicovideo.jp/thumbnail/nc142914?size=l" sizes="16×16" type="image/png" />  
<style>
html,body{margin:0;height:100%;background:#020617;color:#e5ecff;font-family:system-ui;overscroll-behavior:none}
.wrap{display:grid;place-items:center;height:100%}
canvas{background:#070b1f;border-radius:14px;touch-action:none}
.ui{font-size:12px;margin-top:6px;opacity:.85;text-align:center}
.btn{position:absolute;padding:12px 16px;background:rgba(30,40,80,.7);border-radius:12px}
#bombBtn{right:12px;bottom:80px}
#pauseBtn{right:12px;top:12px}
.menu{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.7)}
.menuBox{background:#0b1220;padding:24px 36px;border-radius:18px}
.menuItem{margin:10px 0;font-size:22px;opacity:.5;cursor:pointer}
.menuItem.sel{opacity:1;color:#ff6b6b;transform:scale(1.25)}
</style>
</head>
<body>

<div class="wrap">
<canvas id="c" width="360" height="480"></canvas>
<div class="ui">
PC: 移動WASD/矢印｜Shift低速｜Z射撃｜X AUTO｜Bボム｜Pポーズ<br>
スマホ: ドラッグ移動｜2本指低速｜画面タップ射撃
</div>
</div>

<div class="btn" id="bombBtn">BOMB</div>
<div class="btn" id="pauseBtn">PAUSE</div>

<div class="menu" id="menu">
  <div class="menuBox">
    <div class="menuItem">Easy</div>
    <div class="menuItem">Normal</div>
    <div class="menuItem">Hard</div>
    <div class="menuItem">Lunatic</div>
    <div style="opacity:.6;font-size:12px;margin-top:14px">↑↓ / Enter</div>
  </div>
</div>

<script>
const c=document.getElementById("c"),ctx=c.getContext("2d");
const W=360,H=480;
const keys={};
let paused=false,autoFire=true,flash=0,slowMo=0;

/* ==== 入力 ==== */
addEventListener("keydown",e=>{
  keys[e.key]=true;
  if(e.key==="p")paused=!paused;
  if(e.key==="x")autoFire=!autoFire;
});
addEventListener("keyup",e=>keys[e.key]=false);

/* ==== タッチ ==== */
let touchX=W/2,touchY=H-80,touching=false,slowTouch=false;
c.addEventListener("touchstart",e=>{
  touching=true;
  slowTouch=e.touches.length>=2;
});
c.addEventListener("touchmove",e=>{
  e.preventDefault();
  const r=c.getBoundingClientRect(),t=e.touches[0];
  touchX=(t.clientX-r.left)/r.width*W;
  touchY=(t.clientY-r.top)/r.height*H;
  slowTouch=e.touches.length>=2;
},{passive:false});
c.addEventListener("touchend",()=>{touching=false;slowTouch=false});

/* ==== ボタン ==== */
bombBtn.onclick=()=>bombUse();
pauseBtn.onclick=()=>paused=!paused;

/* ==== 判定 ==== */
const hit=(ax,ay,bx,by,r)=>((ax-bx)**2+(ay-by)**2<r*r);

/* ==== 難易度 ==== */
const DIFF={
  easy:{hp:1200},
  normal:{hp:2000},
  hard:{hp:2800},
  lunatic:{hp:4200}
};

/* ==== ゲーム状態 ==== */
let mode=null,frame=0;
let bullets=[],shots=[],enemies=[],boss=null,items=[];
let score=0,hiScore=0,phase="mob";

/* ==== 残機・ボム ==== */
let life=3,lifeFrag=0,bomb=3,bombFrag=0;
const MAX_LIFE=8,MAX_BOMB=8;
let inv=0;

/* ==== 自機 ==== */
const player={x:W/2,y:H-60,r:3,s:3.2,slow:1.4};

/* ==== メニュー ==== */
const menu=document.getElementById("menu");
const itemsMenu=[...document.querySelectorAll(".menuItem")];
let sel=0;
itemsMenu.forEach((m,i)=>m.onclick=()=>{sel=i;start();});
itemsMenu[0].classList.add("sel");

addEventListener("keydown",e=>{
  if(menu.style.display!=="grid")return;
  if(e.key==="ArrowDown")sel=(sel+1)%4;
  if(e.key==="ArrowUp")sel=(sel+3)%4;
  if(e.key==="Enter")start();
  itemsMenu.forEach((m,i)=>m.classList.toggle("sel",i===sel));
});

/* ==== 開始 ==== */
function start(){
  mode=itemsMenu[sel].textContent.toLowerCase();
  menu.style.display="none";
  frame=score=0;paused=false;
  bullets=[];shots=[];enemies=[];items=[];
  life=3;lifeFrag=0;bomb=3;bombFrag=0;inv=0;
  boss=null;phase="mob";
  hiScore=+localStorage.getItem("hi_"+mode)||0;
}

/* ==== 射撃 ==== */
function shoot(){
  if(frame%5)return;
  [-6,-2,2,6].forEach(dx=>{
    shots.push({x:player.x+dx,y:player.y-8,vx:dx*0.05,vy:-6});
  });
}

/* ==== ボム ==== */
function bombUse(){
  if(bomb<=0)return;
  bomb--;
  bullets=[];
  inv=240;
  flash=15;
  if(boss) boss.hp-=200;
}

/* ==== 敵 ==== */
function spawnEnemy(){
  enemies.push({x:Math.random()*320+20,y:-20,hp:6,t:0});
}

/* ==== 更新 ==== */
function update(){
  if(!mode||paused)return;
  frame++; score++; if(inv>0)inv--;
  if(flash>0)flash--;
  if(slowMo>0)slowMo--;

  const sp=(slowTouch||keys.Shift)?player.slow:player.s;
  if(keys.ArrowLeft||keys.a)player.x-=sp;
  if(keys.ArrowRight||keys.d)player.x+=sp;
  if(keys.ArrowUp||keys.w)player.y-=sp;
  if(keys.ArrowDown||keys.s)player.y+=sp;

  if(touching){
    player.x+=(touchX-player.x)*0.25;
    player.y+=(touchY-player.y)*0.25;
  }

  player.x=Math.max(10,Math.min(W-10,player.x));
  player.y=Math.max(10,Math.min(H-10,player.y));

  if(autoFire||touching||keys.z)shoot();

  shots.forEach(s=>{s.x+=s.vx;s.y+=s.vy});
  shots=shots.filter(s=>s.y>-20);

  if(phase==="mob"){
    if(frame%40===0)spawnEnemy();
    if(frame>900){
      phase="boss";
      boss={x:W/2,y:80,hp:DIFF[mode].hp,maxHp:DIFF[mode].hp};
    }
  }

  enemies.forEach(e=>{
    e.t++; e.y+=1.4;
    if(e.t%60===0){
      const a=Math.atan2(player.y-e.y,player.x-e.x);
      bullets.push({x:e.x,y:e.y,vx:Math.cos(a)*2,vy:Math.sin(a)*2,r:6,hit:3});
    }
  });

  enemies.forEach(e=>{
    shots.forEach(s=>{
      if(hit(s.x,s.y,e.x,e.y,10)){
        e.hp--; s.y=-999; score+=50;
        if(Math.random()<0.25){
          items.push({
            x:e.x,y:e.y,vy:1.2,
            type:Math.random()<0.5?"life":"bomb"
          });
        }
      }
    });
  });

  enemies=enemies.filter(e=>e.y<H+30&&e.hp>0);

  if(boss){
    boss.x=W/2+Math.sin(frame*0.015)*90;
    if(mode==="lunatic"&&bullets.length<1200&&frame%10===0){
      for(let i=0;i<24;i++){
        const a=i/24*Math.PI*2+frame*0.05;
        bullets.push({x:boss.x,y:boss.y,vx:Math.cos(a)*2.5,vy:Math.sin(a)*2.5,r:5,hit:3});
      }
    }
  }

  bullets.forEach(b=>{
    b.x+=b.vx;b.y+=b.vy;
    if(inv<=0&&hit(b.x,b.y,player.x,player.y,b.hit+player.r)){
      life--;inv=120;bullets=[];slowMo=20;
      if(life<0){mode=null;menu.style.display="grid";}
    }
  });
  bullets=bullets.filter(b=>b.x>-40&&b.x<W+40&&b.y>-40&&b.y<H+40);

  /* ==== アイテム ==== */
  items.forEach(it=>{
    it.y+=it.vy;
    if(player.y<120){
      it.x+=(player.x-it.x)*0.1;
      it.y+=(player.y-it.y)*0.1;
    }
    if(hit(it.x,it.y,player.x,player.y,12)){
      if(it.type==="life"&&life<MAX_LIFE){
        if(++lifeFrag>=3){lifeFrag=0;life++;}
      }
      if(it.type==="bomb"&&bomb<MAX_BOMB){
        if(++bombFrag>=3){bombFrag=0;bomb++;}
      }
      it.y=9999;
    }
  });
  items=items.filter(it=>it.y<H+20);

  shots.forEach(s=>{
    if(boss&&hit(s.x,s.y,boss.x,boss.y,22)){
      boss.hp--; s.y=-999;
      if(boss.hp<=0){
        if(score>hiScore)localStorage.setItem("hi_"+mode,score);
        mode=null;menu.style.display="grid";
      }
    }
  });
}

/* ==== 描画 ==== */
function draw(){
  ctx.clearRect(0,0,W,H);

  if(flash>0){
    ctx.fillStyle="#fff";
    ctx.globalAlpha=0.2;
    ctx.fillRect(0,0,W,H);
    ctx.globalAlpha=1;
  }

  shots.forEach(s=>{ctx.fillStyle="#aaf";ctx.fillRect(s.x-2,s.y-8,4,8)});
  bullets.forEach(b=>{ctx.fillStyle="#f55";ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill()});
  enemies.forEach(e=>{ctx.fillStyle="#ff0";ctx.beginPath();ctx.arc(e.x,e.y,10,0,Math.PI*2);ctx.fill()});

  items.forEach(it=>{
    ctx.fillStyle=it.type==="life"?"#ff8888":"#88ccff";
    ctx.beginPath();ctx.arc(it.x,it.y,6,0,Math.PI*2);ctx.fill();
  });

  if(boss){
    ctx.fillStyle="#333";ctx.fillRect(40,20,280,6);
    ctx.fillStyle="#ff66cc";ctx.fillRect(40,20,280*(boss.hp/boss.maxHp),6);
    ctx.fillStyle="#ff00ff";
    ctx.beginPath();ctx.arc(boss.x,boss.y,22,0,Math.PI*2);ctx.fill();
  }

  if(inv%10<5){
    ctx.fillStyle="#fff";
    ctx.beginPath();ctx.arc(player.x,player.y,6,0,Math.PI*2);ctx.fill();
    if(slowTouch||keys.Shift){
      ctx.strokeStyle="#0ff";
      ctx.beginPath();ctx.arc(player.x,player.y,player.r+2,0,Math.PI*2);ctx.stroke();
    }
  }

  ctx.fillStyle="#fff";
  ctx.fillText(`S:${score} HI:${hiScore}`,6,14);
  ctx.fillText(`L:${life}(${lifeFrag}/3) B:${bomb}(${bombFrag}/3)`,6,H-10);
}

(function loop(){
  for(let i=0;i<(slowMo?0.5:1);i++)update();
  draw();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
