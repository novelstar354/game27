<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>東方風 弾幕STG - Full Integrated</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
html,body{
  margin:0;height:100%;
  background:#020617;color:#e5ecff;
  font-family:system-ui;
  overscroll-behavior:none;
}
.wrap{display:grid;place-items:center;height:100%}
canvas{
  background:#070b1f;
  border-radius:14px;
  max-width:100vw;
  max-height:100vh;
  touch-action:none;
}
.ui{font-size:12px;margin-top:6px;opacity:.85;text-align:center}
.btn{
  position:absolute;
  padding:12px 16px;
  background:rgba(30,40,80,.7);
  border-radius:12px;
  font-size:14px;
  user-select:none;
}
#bombBtn{right:12px;bottom:80px}
#pauseBtn{right:12px;top:12px}
.menu{
  position:absolute;inset:0;
  display:grid;place-items:center;
  background:rgba(0,0,0,.7)
}
.menuBox{
  background:#0b1220;
  padding:24px 36px;
  border-radius:18px;
}
.menuItem{
  margin:10px 0;
  font-size:22px;
  opacity:.5;
  cursor:pointer;
}
.menuItem.sel{
  opacity:1;color:#ff6b6b;
  transform:scale(1.25)
}
</style>
</head>
<body>

<div class="wrap">
<canvas id="c" width="360" height="480"></canvas>
<div class="ui">
PC: WASD/矢印｜Shift低速｜Z射撃｜X AUTO｜Bボム｜Pポーズ<br>
スマホ: ドラッグ移動｜2本指低速｜タップ射撃
</div>
</div>

<div class="btn" id="bombBtn">BOMB</div>
<div class="btn" id="pauseBtn">PAUSE</div>

<div class="menu" id="menu">
  <div class="menuBox">
    <div class="menuItem">Easy</div>
    <div class="menuItem">Normal</div>
    <div class="menuItem">Hard</div>
    <div class="menuItem">Lunatic</div>
    <div style="opacity:.6;font-size:12px;margin-top:14px">
      ↑↓ 選択 / Enter 決定<br>スマホ: タップ
    </div>
  </div>
</div>

<script>
/* ===== 基本 ===== */
const c=document.getElementById("c"),ctx=c.getContext("2d");
const W=360,H=480;
const keys={};
addEventListener("keydown",e=>{
  keys[e.key]=true;
  if(e.key==="p")paused=!paused;
});
addEventListener("keyup",e=>keys[e.key]=false);

/* ===== タッチ ===== */
let touchX=W/2,touchY=H-80,touching=false,slowTouch=false;
c.addEventListener("touchstart",e=>{
  touching=true;
  slowTouch=e.touches.length>=2;
  const r=c.getBoundingClientRect(),t=e.touches[0];
  touchX=(t.clientX-r.left)/r.width*W;
  touchY=(t.clientY-r.top)/r.height*H;
},{passive:false});
c.addEventListener("touchmove",e=>{
  e.preventDefault();
  slowTouch=e.touches.length>=2;
  const r=c.getBoundingClientRect(),t=e.touches[0];
  touchX=(t.clientX-r.left)/r.width*W;
  touchY=(t.clientY-r.top)/r.height*H;
},{passive:false});
c.addEventListener("touchend",()=>{touching=false;slowTouch=false});

/* ===== ボタン ===== */
bombBtn.onclick=()=>bombUse();
pauseBtn.onclick=()=>paused=!paused;

/* ===== 判定 ===== */
const hit=(ax,ay,bx,by,r)=>{
  const dx=ax-bx,dy=ay-by;
  return dx*dx+dy*dy<r*r;
};

/* ===== 難易度 ===== */
const DIFF={
  easy:{b:1,hp:1200},
  normal:{b:1.4,hp:2000},
  hard:{b:1.9,hp:2800},
  lunatic:{b:2.7,hp:4200}
};

let mode=null,frame=0,paused=false;
let bullets=[],shots=[],enemies=[];
let boss=null;
let life=3,bomb=3,inv=0;
let autoFire=true,score=0,hiScore=0,phase="mob";

const player={x:W/2,y:H-60,r:3,s:3.2,slow:1.4};

/* ===== メニュー ===== */
const menu=document.getElementById("menu");
const items=[...document.querySelectorAll(".menuItem")];
let sel=0;
items.forEach((m,i)=>m.onclick=()=>{sel=i;start();});
addEventListener("keydown",e=>{
  if(!menu.style.display)return;
  if(e.key==="ArrowDown")sel=(sel+1)%4;
  if(e.key==="ArrowUp")sel=(sel+3)%4;
  if(e.key==="Enter")start();
  updateMenu();
});
const updateMenu=()=>items.forEach((m,i)=>m.classList.toggle("sel",i===sel));
updateMenu();

/* ===== 開始 ===== */
function start(){
  mode=items[sel].textContent.toLowerCase();
  menu.style.display="none";
  frame=0;paused=false;
  bullets=[];shots=[];enemies=[];
  life=3;bomb=3;inv=0;
  score=0;phase="mob";
  hiScore=+localStorage.getItem("hi_"+mode)||0;
  boss=null;
}

/* ===== 自機 ===== */
function shoot(){
  if(frame%5!==0)return;
  [-6,-2,2,6].forEach(dx=>{
    shots.push({x:player.x+dx,y:player.y-8,vx:dx*0.05,vy:-6});
  });
}
function bombUse(){
  if(bomb<=0)return;
  bomb--;bullets=[];inv=180;
}

/* ===== 敵 ===== */
function spawnEnemy(){
  enemies.push({
    x:Math.random()*(W-40)+20,
    y:-20,
    vx:(Math.random()<.5?-1:1)*0.6,
    speed:1.4,
    hp:6,t:0
  });
}

/* ===== 更新 ===== */
function update(){
  if(!mode||paused)return;
  frame++;score++;if(inv>0)inv--;

  const sp=(slowTouch||keys.Shift)?player.slow:player.s;
  if(touching){
    player.x+=(touchX-player.x)*0.2;
    player.y+=(touchY-player.y)*0.2;
  }else{
    if(keys.ArrowLeft||keys.a)player.x-=sp;
    if(keys.ArrowRight||keys.d)player.x+=sp;
    if(keys.ArrowUp||keys.w)player.y-=sp;
    if(keys.ArrowDown||keys.s)player.y+=sp;
  }
  player.x=Math.max(10,Math.min(W-10,player.x));
  player.y=Math.max(10,Math.min(H-10,player.y));

  if(autoFire||touching||keys.z)shoot();

  shots.forEach(s=>{s.x+=s.vx;s.y+=s.vy});
  shots=shots.filter(s=>s.y>-20);

  if(phase==="mob"){
    if(frame%40===0)spawnEnemy();
    if(frame>900){
      phase="boss";
      boss={x:W/2,y:80,hp:DIFF[mode].hp,maxHp:DIFF[mode].hp,form:1};
    }
  }

  enemies.forEach(e=>{
    e.t++;e.x+=e.vx;e.y+=e.speed;
    if(e.t%60===0){
      const a=Math.atan2(player.y-e.y,player.x-e.x);
      bullets.push({x:e.x,y:e.y,vx:Math.cos(a)*2,vy:Math.sin(a)*2,r:3});
    }
  });
  enemies=enemies.filter(e=>e.y<H+30&&e.hp>0);

  if(boss){
    boss.x=W/2+Math.sin(frame*0.01)*80;
    if(mode==="lunatic"){
      if(boss.hp<boss.maxHp*0.66)boss.form=2;
      if(boss.hp<boss.maxHp*0.33)boss.form=3;
      if(boss.hp<boss.maxHp*0.15)boss.form=4;
    }
    if(frame%16===0){
      const n=boss.form===4?64:32;
      const spd=boss.form*1.4;
      for(let i=0;i<n;i++){
        const a=i/n*Math.PI*2+frame*0.02;
        bullets.push({x:boss.x,y:boss.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:4});
      }
    }
  }

  bullets.forEach(b=>{
    b.x+=b.vx;b.y+=b.vy;
    if(inv<=0&&hit(b.x,b.y,player.x,player.y,b.r+player.r)){
      life--;inv=120;bullets=[];
      if(life<0)mode=null,menu.style.display="grid";
    }
  });
  bullets=bullets.filter(b=>b.x>-30&&b.x<W+30&&b.y>-30&&b.y<H+30);

  shots.forEach(s=>{
    enemies.forEach(e=>{
      if(hit(s.x,s.y,e.x,e.y,10)){e.hp--;s.y=-999;score+=50;}
    });
    if(boss&&hit(s.x,s.y,boss.x,boss.y,20)){
      boss.hp--;s.y=-999;
      if(boss.hp<=0){
        if(score>hiScore)localStorage.setItem("hi_"+mode,score);
        mode=null;menu.style.display="grid";
      }
    }
  });
}

/* ===== 描画 ===== */
function draw(){
  ctx.clearRect(0,0,W,H);

  shots.forEach(s=>{
    ctx.fillStyle="#7df9ff";
    ctx.fillRect(s.x-2,s.y-8,4,8);
  });

  bullets.forEach(b=>{
    ctx.fillStyle="#ff5cff";
    ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();
  });

  enemies.forEach(e=>{
    ctx.fillStyle="#ff9f1c";
    ctx.beginPath();ctx.arc(e.x,e.y,10,0,Math.PI*2);ctx.fill();
  });

  if(boss){
    ctx.fillStyle=boss.form===4?"#fff":"#ff00ff";
    ctx.beginPath();ctx.arc(boss.x,boss.y,22,0,Math.PI*2);ctx.fill();
  }

  if(inv%10<5){
    ctx.fillStyle="#4cc9ff";
    ctx.beginPath();ctx.arc(player.x,player.y,6,0,Math.PI*2);ctx.fill();
    if(slowTouch||keys.Shift){
      ctx.strokeStyle="#fff";
      ctx.beginPath();ctx.arc(player.x,player.y,player.r+1,0,Math.PI*2);ctx.stroke();
    }
  }

  ctx.fillStyle="#fff";
  ctx.fillText(`S:${score} HI:${hiScore}`,6,14);
  ctx.fillText(`LIFE:${life} BOMB:${bomb}`,6,H-10);
}

(function loop(){update();draw();requestAnimationFrame(loop)})();
</script>
</body>
</html>
